name: Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          API_KEY: ${{ secrets.API_KEY }}

      - name: Deploy to Vercel (Preview)
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DEPLOYMENT_URL}" >> "$GITHUB_OUTPUT"
          echo "Preview deployed to: ${DEPLOYMENT_URL}"

      - name: Comment PR with preview URL
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deployUrl = '${{ steps.deploy.outputs.url }}';
            const body = [
              '## Preview Deployment',
              '',
              `Preview URL: ${deployUrl}`,
              '',
              `Commit: \`${context.sha.substring(0, 7)}\``,
              `Branch: \`${context.payload.pull_request.head.ref}\``,
              '',
              '---',
              '_This comment is automatically updated on each push._',
            ].join('\n');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(
              (comment) =>
                comment.user.type === 'Bot' &&
                comment.body.includes('## Preview Deployment')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

# ============================================================
# Required GitHub Secrets:
# ============================================================
# VERCEL_TOKEN       - Vercel API token (Settings > Tokens)
# VERCEL_ORG_ID      - Vercel organization ID (.vercel/project.json)
# VERCEL_PROJECT_ID  - Vercel project ID (.vercel/project.json)
# SESSION_SECRET     - Application session encryption key
# API_KEY            - Application API key
# ============================================================
